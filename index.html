<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音学Timer</title>
    
    <!-- Google Fonts for a clean look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@700&family=Yusei+Magic&display=swap" rel="stylesheet">

    <style>
        /* --- CSSリセットと基本設定 --- */
        :root {
            --navy-darker: #1e3a8a;
            --navy-dark: #1e40af;
            --navy-base: #1d4ed8;
            --navy-light: #2563eb;
            --blue-900: #1e3a8a;
            --blue-800: #1e40af;
            --red-600: #dc2626;
            --red-700: #b91c1c;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --white: #ffffff;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Yusei Magic', sans-serif;
            background-color: var(--navy-darker);
            color: var(--gray-800);
            -webkit-tap-highlight-color: transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }

        /* --- コンポーネントスタイル --- */
        .timer-card {
            width: 100%;
            max-width: 448px; /* md */
            margin-left: auto;
            margin-right: auto;
            background-color: var(--white);
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1rem;
        }

        .main-content {
            display: block;
        }

        .left-column, .right-column {
            display: flex;
            flex-direction: column;
        }
        
        .left-column {
            gap: 1.5rem;
        }
        
        .right-column {
             gap: 0.75rem;
        }

        header {
            text-align: center;
        }
        header h1 {
            font-size: 2.25rem;
            line-height: 2.5rem;
            color: var(--blue-900);
        }
        header p {
            color: var(--gray-600);
            margin-top: 0.25rem;
        }

        #music-settings {
            padding-top: 1.5rem;
            border-top: 1px solid var(--gray-200);
        }
        #music-settings h2 {
            font-size: 1.125rem;
            line-height: 1.75rem;
            color: var(--blue-900);
            margin-bottom: 1rem;
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.5rem;
            font-size: 0.875rem;
            line-height: 1rem;
        }

        .radio-label {
            display: block;
            cursor: pointer;
            text-align: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: var(--gray-100);
            transition: all 0.2s;
        }
        .radio-label:hover {
            background-color: var(--gray-200);
        }
        input[type="radio"]:checked + .radio-label {
            background-color: var(--blue-800);
            color: var(--white);
        }

        #custom-music-label.selected {
            background-color: var(--blue-900);
            color: var(--white);
        }
        
        .radio-label.error {
            background-color: var(--red-600) !important;
            color: var(--white) !important;
        }

        .volume-control {
            margin-top: 1rem;
        }
        .volume-control label {
            display: block;
            font-size: 0.875rem;
            line-height: 1.25rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }
        
        .volume-slider {
            width: 100%;
        }

        main {
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
            margin-top: 2rem;
        }

        #timer-display {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            text-align: center;
            letter-spacing: 0.05em;
            font-size: 3rem;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        .toggle-container span {
            font-size: 0.875rem;
            line-height: 1.25rem;
            color: var(--gray-600);
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 2.5rem;
            height: 1.5rem;
            vertical-align: middle;
            user-select: none;
        }
        .toggle-checkbox {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-300);
            transition: .4s;
            border-radius: 9999px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 1.125rem;
            width: 1.125rem;
            left: 0.1875rem;
            bottom: 0.1875rem;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        .toggle-checkbox:checked + .toggle-slider {
            background-color: var(--navy-dark);
        }
        .toggle-checkbox:checked + .toggle-slider:before {
            transform: translateX(1rem);
        }


        #start-stop-button {
            width: 100%;
            max-width: 24rem;
            margin: 0 auto;
            background-color: var(--blue-800);
            color: var(--white);
            font-weight: 700;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            font-size: 1.125rem;
            line-height: 1.75rem;
            transition: all 0.3s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: none;
            cursor: pointer;
        }
        #start-stop-button:hover {
            background-color: var(--blue-900);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #start-stop-button:active {
            transform: scale(0.95);
        }
        #start-stop-button.studying {
            background-color: var(--red-600);
        }
        #start-stop-button.studying:hover {
            background-color: var(--red-700);
        }

        #total-time-display {
            text-align: center;
            font-size: 1.125rem;
            line-height: 1.75rem;
            color: var(--gray-700);
        }

        #past-history-display {
            text-align: center;
            font-size: 0.75rem;
            line-height: 1rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }

        .app-footer {
            color: var(--white);
            font-size: 0.75rem;
            line-height: 1rem;
            margin-top: 1rem;
        }

        /* レスポンシブデザイン */
        @media (min-width: 640px) { /* sm */
            .timer-card {
                padding: 2rem;
            }
            .button-grid {
                font-size: 1rem;
                line-height: 1.25rem;
            }
            #timer-display {
                font-size: 3.75rem;
            }
             #start-stop-button {
                font-size: 1.25rem;
             }
        }

        @media (min-width: 768px) { /* md */
            .timer-card {
                max-width: 896px;
                padding: 2rem;
            }
            .main-content {
                display: grid;
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 3rem;
                align-items: center;
            }
            .left-column {
                gap: 2rem;
            }
            header {
                text-align: left;
            }
            header h1 {
                font-size: 3rem;
                line-height: 1;
            }
            main {
                margin-top: 0;
                gap: 1rem;
            }
        }
        
        @media (min-width: 1024px) { /* lg */
             #timer-display {
                font-size: 4.5rem;
            }
        }

        /* ユーティリティ */
        .hidden {
            display: none;
        }
        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>
<body>

    <div class="timer-card">
        
        <div class="main-content">
            
            <div class="left-column">
                <header>
                    <h1>音学Timer</h1>
                    <p>学習タイムを、音楽で彩ろう。</p>
                    <p>可視化しよう。</p>
                </header>

                <section id="music-settings">
                    <h2>BGM設定</h2>
                    <div class="button-grid">
                        <div>
                            <input type="radio" name="bgm" id="none" value="none" class="hidden" checked>
                            <label for="none" class="radio-label">なし</label>
                        </div>
                        <div>
                            <label for="custom-music-input" id="custom-music-label" class="radio-label truncate">ファイルを開く</label>
                            <input type="file" id="custom-music-input" accept="audio/*" class="hidden" multiple>
                        </div>
                    </div>
                    <div class="volume-control">
                        <label for="volume-slider">音量調整</label>
                        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.3" class="volume-slider">
                    </div>
                </section>
            </div>

            <main class="right-column">
                <div id="timer-display">00:00:00</div>
                <div class="toggle-container">
                    <span>タイマー表示</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="timer-toggle" class="toggle-checkbox" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <button id="start-stop-button">学習開始</button>
                <div id="total-time-display">本日の学習時間: 0分0秒</div>
                <div id="past-history-display"></div>
            </main>

        </div>
    </div>
    
    <footer class="app-footer">
        Copyright (c) 2025 もなみん
    </footer>

    <audio id="audio-player"></audio>

    <script>
        /**
         * アプリケーション全体を管理するオブジェクト
         */
        const app = {
            // --- 定数 ---
            DB_NAME: 'MusicDB_v2',
            DB_VERSION: 1,
            SECONDS_IN_A_DAY: 86400,

            // --- DOM要素 ---
            elements: {},

            // --- アプリケーションの状態 ---
            state: {
                isStudying: false,
                timerInterval: null,
                autoSaveInterval: null, 
                elapsedSeconds: 0,
                sessionStartTime: null,
                timeAlreadyOnStartDate: 0, 
                timeAlreadyOnCurrentDay: 0,
                studyHistory: {}, // { "YYYY-MM-DD": seconds }
                playlist: [],
                currentTrackIndex: 0,
                lastCheckedDateString: null,
                midnightsCrossed: 0, 
                wakeLock: null,
                db: null,
                currentObjectUrl: null,
            },

            // --- 初期化 ---
            async init() {
                this.elements = {
                    startStopButton: document.getElementById('start-stop-button'),
                    timerDisplay: document.getElementById('timer-display'),
                    totalTimeDisplay: document.getElementById('total-time-display'),
                    pastHistoryDisplay: document.getElementById('past-history-display'),
                    audioPlayer: document.getElementById('audio-player'),
                    bgmRadios: document.querySelectorAll('input[name="bgm"]'),
                    customMusicInput: document.getElementById('custom-music-input'),
                    customMusicLabel: document.getElementById('custom-music-label'),
                    timerToggle: document.getElementById('timer-toggle'),
                    volumeSlider: document.getElementById('volume-slider'),
                };
                
                this.setupEventListeners();
                
                try {
                    this.state.db = await this.db.init();
                } catch (error) {
                    console.error("データベースの初期化に失敗しました:", error);
                }
                
                await this.loadInitialData();
            },

            // --- イベントリスナー設定 ---
            setupEventListeners() {
                this.elements.startStopButton.addEventListener('click', () => this.timer.toggleStudy());
                this.elements.bgmRadios.forEach(radio => {
                    radio.addEventListener('change', () => this.music.updateBgmSource());
                });
                this.elements.customMusicInput.addEventListener('change', (e) => this.music.loadCustomMusic(e));
                this.elements.timerToggle.addEventListener('change', () => this.ui.toggleTimerDisplay());
                this.elements.volumeSlider.addEventListener('input', (e) => this.music.setVolume(e.target.value));
                this.elements.audioPlayer.addEventListener('ended', () => this.music.playNextTrack());
                
                window.addEventListener('pagehide', () => {
                    if (this.state.isStudying) {
                        this.timer.autoSaveProgress(); 
                    }
                });
                
                document.addEventListener('visibilitychange', () => this.system.handleVisibilityChange());
            },
            
            // --- データロード ---
            async loadInitialData() {
                this.storage.loadHistory();
                this.music.loadVolume();
                this.ui.loadTimerVisibility();
                await this.music.loadPlaylistFromDB();
            },

            // --- 機能別メソッド ---

            timer: {
                toggleStudy() {
                    if (app.state.isStudying) {
                        this.stopStudy();
                    } else {
                        this.startStudy();
                    }
                },

                async startStudy() {
                    app.state.isStudying = true;
                    app.state.sessionStartTime = new Date();
                    const today = app.utils.getCurrentDateString();
                    app.state.lastCheckedDateString = today;
                    app.state.midnightsCrossed = 0; 
                    
                    const timeForToday = app.state.studyHistory[today] || 0;
                    app.state.timeAlreadyOnStartDate = timeForToday;
                    app.state.timeAlreadyOnCurrentDay = timeForToday;
                    
                    app.elements.startStopButton.textContent = '学習終了';
                    app.elements.startStopButton.classList.add('studying');
                    
                    app.system.requestWakeLock();

                    if (app.elements.audioPlayer.src && !document.querySelector('#none').checked) {
                        app.elements.audioPlayer.play().catch(e => console.error("音声の再生に失敗しました:", e));
                    }
                    
                    app.state.autoSaveInterval = setInterval(() => this.autoSaveProgress(), 15000);

                    app.state.timerInterval = setInterval(() => {
                        const now = new Date();
                        app.state.elapsedSeconds = Math.floor((now - app.state.sessionStartTime) / 1000);
                        app.elements.timerDisplay.textContent = app.utils.formatTime(app.state.elapsedSeconds);
                        this.handleRealtimeDateCheck();
                    }, 1000);
                },
                
                stopStudy() {
                    if (!app.state.isStudying) return;

                    this.autoSaveProgress(); 
                    this.resetTimerState();      
                    app.ui.updateUI();           
                },
                
                autoSaveProgress() {
                    if (!app.state.isStudying) return;

                    const now = new Date();
                    const today = app.utils.getCurrentDateString(now);

                    let sessionDurationOnThisDay;
                    if (app.state.midnightsCrossed === 0) {
                        sessionDurationOnThisDay = Math.round((now - app.state.sessionStartTime) / 1000);
                    } else {
                        const startOfToday = new Date(today);
                        sessionDurationOnThisDay = Math.round((now - startOfToday) / 1000);
                    }
                    
                    app.state.studyHistory[today] = app.state.timeAlreadyOnCurrentDay + sessionDurationOnThisDay;
                    
                    app.storage.saveHistoryToLocalStorage();
                },
                
                resetTimerState() {
                    app.state.isStudying = false;
                    if (app.state.timerInterval) {
                        clearInterval(app.state.timerInterval);
                        app.state.timerInterval = null;
                    }
                    if (app.state.autoSaveInterval) {
                        clearInterval(app.state.autoSaveInterval);
                        app.state.autoSaveInterval = null;
                    }

                    app.elements.startStopButton.textContent = '学習開始';
                    app.elements.startStopButton.classList.remove('studying');

                    if (app.state.wakeLock) {
                        app.state.wakeLock.release().then(() => { app.state.wakeLock = null; });
                    }

                    app.elements.audioPlayer.pause();
                    
                    app.state.elapsedSeconds = 0;
                    app.state.sessionStartTime = null;
                    app.elements.timerDisplay.textContent = '00:00:00';
                },

                handleRealtimeDateCheck() {
                    const currentDateString = app.utils.getCurrentDateString();
                    if (currentDateString === app.state.lastCheckedDateString) {
                        return; 
                    }

                    const previousDateString = app.state.lastCheckedDateString;
                    const midnight = new Date(currentDateString); 

                    const startOfPreviousDay = (app.state.midnightsCrossed === 0) 
                        ? app.state.sessionStartTime 
                        : new Date(previousDateString);
                        
                    const secondsOnPreviousDay = Math.round((midnight - startOfPreviousDay) / 1000);
                    const baseTimeForPreviousDay = (app.state.midnightsCrossed === 0) ? app.state.timeAlreadyOnStartDate : 0;
                    app.state.studyHistory[previousDateString] = baseTimeForPreviousDay + secondsOnPreviousDay;
                    
                    app.state.midnightsCrossed++;
                    app.state.lastCheckedDateString = currentDateString;
                    app.state.timeAlreadyOnCurrentDay = app.state.studyHistory[currentDateString] || 0;
                    
                    if (app.state.midnightsCrossed >= 2) {
                        app.state.studyHistory[currentDateString] = app.state.timeAlreadyOnCurrentDay;
                        this.resetTimerState(); 
                        
                        app.storage.saveHistoryToLocalStorage();
                        app.ui.updateUI();
                        return; 
                    }

                    app.storage.saveHistoryToLocalStorage();
                    app.ui.updateUI(); 
                }
            },

            music: {
                playTrack(index, shouldPlay = true) {
                    if (app.state.currentObjectUrl) {
                        URL.revokeObjectURL(app.state.currentObjectUrl);
                    }

                    const { playlist } = app.state;
                    if (playlist.length === 0 || index < 0 || index >= playlist.length) return;
                    
                    app.state.currentTrackIndex = index;
                    const file = playlist[index];
                    const url = URL.createObjectURL(file);
                    app.state.currentObjectUrl = url;
                    app.elements.audioPlayer.src = url;
                    
                    if (shouldPlay && app.state.isStudying) {
                        app.elements.audioPlayer.play().catch(e => console.error("音声の再生に失敗しました:", e));
                    }
                    app.db.savePlaylist(playlist, app.state.currentTrackIndex);
                },

                playNextTrack() {
                    const nextIndex = (app.state.currentTrackIndex + 1) % app.state.playlist.length;
                    this.playTrack(nextIndex);
                },
                
                async loadCustomMusic(event) {
                    const files = event.target.files;
                    if (!files || files.length === 0) return;
                    
                    app.state.playlist = Array.from(files).filter(file => file.type.startsWith('audio/'));
                    
                    if (app.state.playlist.length === 0) {
                        app.ui.showTemporaryMessage(app.elements.customMusicLabel, '音声なし', 'ファイルを開く');
                        return;
                    }

                    app.state.currentTrackIndex = 0;

                    try {
                        await app.db.savePlaylist(app.state.playlist, app.state.currentTrackIndex);
                        this.playTrack(app.state.currentTrackIndex);
                        
                        document.querySelector('#none').checked = false;
                        app.elements.customMusicLabel.textContent = `プレイリスト (${app.state.playlist.length}曲)`;
                        app.elements.customMusicLabel.classList.add('selected');
                        localStorage.setItem('bgmSelection', 'custom');
                    } catch (error) {
                        console.error("プレイリストの保存に失敗しました:", error);
                        app.ui.showTemporaryMessage(app.elements.customMusicLabel, '保存失敗');
                    }
                },

                updateBgmSource() {
                    const selectedBgmRadio = document.querySelector('input[name="bgm"]:checked');
                    if (selectedBgmRadio?.value === 'none') {
                        app.elements.audioPlayer.src = '';
                        if (app.state.currentObjectUrl) {
                            URL.revokeObjectURL(app.state.currentObjectUrl);
                            app.state.currentObjectUrl = null;
                        }
                        app.elements.customMusicLabel.classList.remove('selected');
                        app.elements.customMusicLabel.textContent = 'ファイルを開く';
                        localStorage.setItem('bgmSelection', 'none');
                    }
                },

                setVolume(volume) {
                    app.elements.audioPlayer.volume = volume;
                    localStorage.setItem('audioVolume', volume);
                },

                loadVolume() {
                    const savedVolume = localStorage.getItem('audioVolume');
                    if (savedVolume) {
                        app.elements.volumeSlider.value = savedVolume;
                    }
                    app.elements.audioPlayer.volume = app.elements.volumeSlider.value;
                },

                async loadPlaylistFromDB() {
                    if (!app.state.db) {
                        console.warn("DBが利用不可のため、プレイリストは復元されません。");
                        document.querySelector('#none').checked = true;
                        this.updateBgmSource();
                        return;
                    }
                    try {
                        const playlistData = await app.db.loadPlaylist();
                        const savedBgmSelection = localStorage.getItem('bgmSelection');

                        if (savedBgmSelection === 'custom' && playlistData?.files?.length > 0) {
                            app.state.playlist = playlistData.files;
                            app.state.currentTrackIndex = playlistData.index || 0;
                            this.playTrack(app.state.currentTrackIndex, false);

                            document.querySelector('#none').checked = false;
                            app.elements.customMusicLabel.textContent = `プレイリスト (${app.state.playlist.length}曲)`;
                            app.elements.customMusicLabel.classList.add('selected');
                        } else {
                            document.querySelector('#none').checked = true;
                            this.updateBgmSource();
                        }
                    } catch (error) {
                        console.error("プレイリストの読み込みに失敗:", error);
                        document.querySelector('#none').checked = true;
                        this.updateBgmSource();
                    }
                }
            },
            
            ui: {
                updateUI() {
                    // 当日の合計時間を更新
                    const today = app.utils.getCurrentDateString();
                    const totalSecondsToday = app.state.studyHistory[today] || 0;
                    app.elements.totalTimeDisplay.textContent = `本日の学習時間: ${app.utils.formatTotalTime(totalSecondsToday)}`;
                    
                    // 過去5日間の履歴を更新
                    let historyHtml = '';
                    for (let i = 1; i <= 5; i++) {
                        const pastDate = new Date();
                        pastDate.setDate(pastDate.getDate() - i);
                        const dateString = app.utils.getCurrentDateString(pastDate);
                        const totalSeconds = app.state.studyHistory[dateString] || 0;

                        const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][pastDate.getDay()];
                        const formattedDate = `${pastDate.getMonth() + 1}月${pastDate.getDate()}日(${dayOfWeek})`;
                        historyHtml += `<div>${formattedDate}: ${app.utils.formatTotalTime(totalSeconds)}</div>`;
                    }
                    app.elements.pastHistoryDisplay.innerHTML = historyHtml;
                },

                toggleTimerDisplay() {
                    const isVisible = app.elements.timerToggle.checked;
                    app.elements.timerDisplay.style.display = isVisible ? 'block' : 'none';
                    localStorage.setItem('timerDisplayVisible', isVisible);
                },

                loadTimerVisibility() {
                    const savedTimerVisibility = localStorage.getItem('timerDisplayVisible');
                    if (savedTimerVisibility !== null) {
                        const isVisible = savedTimerVisibility === 'true';
                        app.elements.timerToggle.checked = isVisible;
                        app.elements.timerDisplay.style.display = isVisible ? 'block' : 'none';
                    }
                },
                
                showTemporaryMessage(element, message, originalText = null) {
                    const prevText = originalText || element.textContent;
                    element.textContent = message;
                    element.classList.add('error');
                    setTimeout(() => {
                        element.textContent = prevText;
                        element.classList.remove('error');
                    }, 2500);
                }
            },

            storage: {
                loadHistory() {
                    const savedHistory = localStorage.getItem('studyHistory');
                    if (savedHistory) {
                        app.state.studyHistory = JSON.parse(savedHistory);
                        this.cleanupOldHistory();
                    }
                    app.ui.updateUI();
                },
                
                saveHistoryToLocalStorage() {
                    localStorage.setItem('studyHistory', JSON.stringify(app.state.studyHistory));
                },
                
                cleanupOldHistory() {
                    const sixDaysAgo = new Date();
                    sixDaysAgo.setDate(sixDaysAgo.getDate() - 6);
                    sixDaysAgo.setHours(0, 0, 0, 0);

                    Object.keys(app.state.studyHistory).forEach(dateString => {
                        if (new Date(dateString) < sixDaysAgo) {
                            delete app.state.studyHistory[dateString];
                        }
                    });
                    this.saveHistoryToLocalStorage();
                },
            },

            system: {
                async requestWakeLock() {
                    if (!('wakeLock' in navigator)) {
                        console.log('このブラウザはScreen Wake Lock APIをサポートしていません。');
                        return;
                    }
                    try {
                        if (app.state.wakeLock) return;

                        app.state.wakeLock = await navigator.wakeLock.request('screen');
                        
                        app.state.wakeLock.addEventListener('release', () => {
                            console.log('スリープ防止機能が解除されました。');
                            app.state.wakeLock = null;
                        });
                        console.log('スリープ防止機能が有効になりました。');
                    } catch (err) {
                        console.error(`スリープ防止機能の有効化に失敗しました: ${err.name}, ${err.message}`);
                        app.state.wakeLock = null; 
                    }
                },

                handleVisibilityChange() {
                    if (app.state.isStudying && document.visibilityState === 'visible') {
                        this.requestWakeLock();
                    }
                },
            },
            
            db: {
                init() {
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open(app.DB_NAME, app.DB_VERSION);
                        request.onerror = () => reject("IndexedDBエラー: " + request.error);
                        request.onsuccess = (event) => resolve(event.target.result);
                        request.onupgradeneeded = (event) => {
                            const db = event.target.result;
                            if (!db.objectStoreNames.contains('playlist')) {
                                db.createObjectStore('playlist', { keyPath: 'id' });
                            }
                        };
                    });
                },
                savePlaylist(files, index) {
                    return new Promise((resolve, reject) => {
                        if (!app.state.db) return reject("DBが初期化されていません");
                        const transaction = app.state.db.transaction(['playlist'], 'readwrite');
                        const store = transaction.objectStore('playlist');
                        const request = store.put({ id: 'lastPlaylist', files, index });
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject("プレイリストの保存に失敗しました: " + request.error);
                    });
                },
                loadPlaylist() {
                    return new Promise((resolve, reject) => {
                        if (!app.state.db) return reject("DBが初期化されていません");
                        const transaction = app.state.db.transaction(['playlist'], 'readonly');
                        const store = transaction.objectStore('playlist');
                        const request = store.get('lastPlaylist');
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject("プレイリストの読み込みに失敗しました: " + request.error);
                    });
                }
            },

            utils: {
                formatTime(totalSeconds) {
                    const h = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
                    const m = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
                    const s = (totalSeconds % 60).toString().padStart(2, '0');
                    return `${h}:${m}:${s}`;
                },
                formatTotalTime(totalSeconds) {
                    if (!totalSeconds) return '0分0秒';
                    if (totalSeconds < 60) return `${totalSeconds}秒`;
                    const h = Math.floor(totalSeconds / 3600);
                    const m = Math.floor((totalSeconds % 3600) / 60);
                    const s = totalSeconds % 60;
                    let result = '';
                    if (h > 0) result += `${h}時間`;
                    if (m > 0) result += `${m}分`;
                    if (s > 0 || (h === 0 && m === 0)) result += `${s}秒`;
                    return result.trim();
                },
                getCurrentDateString(date = new Date()) {
                    const year = date.getFullYear();
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const day = date.getDate().toString().padStart(2, '0');
                    return `${year}-${month}-${day}`;
                },
            },
        };

        window.addEventListener('load', () => app.init());
    </script>
</body>
</html>
